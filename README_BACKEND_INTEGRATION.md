# Browser Extension + Backend Integration

Complete integration between the GTM Chrome Extension and the backend API for event intelligence data persistence.

## ğŸ¯ Overview

The backend now captures **100% of the data** generated by the browser extension:

- âœ… Event metadata (name, dates, location, description, attendee counts)
- âœ… People (speakers, attendees, with LinkedIn profiles and conversation starters)
- âœ… Sponsors (names and tiers)
- âœ… Target personas (with conversation starters, keywords, pain points)
- âœ… Next best actions (prioritized recommendations)
- âœ… Related events (similar conferences)
- âœ… User profiles (company info, target personas, deal metrics)

## ğŸ“ Files Created

### Backend Files
```
unified-mcp-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ event-db.ts           # Database schema & CRUD operations
â”‚   â”œâ”€â”€ event-api.ts          # REST API route handlers
â”‚   â”œâ”€â”€ http-server.ts        # Updated Express server (integrated)
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ init-db.ts        # Manual DB initialization script
â”œâ”€â”€ EVENT_API.md              # Complete API documentation
â””â”€â”€ package.json              # Updated with init-db script
```

### Documentation Files
```
â”œâ”€â”€ BACKEND_SETUP_SUMMARY.md          # Quick start guide
â”œâ”€â”€ EXTENSION_BACKEND_INTEGRATION.md  # Extension integration steps
â””â”€â”€ README_BACKEND_INTEGRATION.md     # This file
```

## ğŸš€ Quick Start

### 1. Backend Setup

```bash
cd unified-mcp-server

# Install dependencies
npm install

# Create .env file
cat > .env << EOF
TURSO_DATABASE_URL=libsql://your-database.turso.io
TURSO_AUTH_TOKEN=your_turso_auth_token
MCP_BEARER_TOKEN=optional_secure_token
PORT=3000
EOF

# Build TypeScript
npm run build

# Initialize database (auto-runs on server start, but can run manually)
npm run init-db

# Start server
npm start
```

Server starts on `http://localhost:3000`

### 2. Verify Backend

```bash
# Health check
curl http://localhost:3000/health

# Expected response:
# {
#   "status": "ok",
#   "server": "unified-mcp",
#   "version": "1.0.0",
#   "tools": 19,
#   "eventApi": "enabled"
# }
```

### 3. Test Event Storage

```bash
curl -X POST http://localhost:3000/api/events \
  -H "Content-Type: application/json" \
  -H "X-User-Id: test_user" \
  -d '{
    "url": "https://example.com/conference",
    "eventName": "Test Conference 2026",
    "date": "March 15, 2026",
    "startDate": "2026-03-15",
    "endDate": "2026-03-15",
    "location": "San Francisco",
    "people": [],
    "sponsors": [],
    "expectedPersonas": [],
    "nextBestActions": [],
    "relatedEvents": []
  }'
```

### 4. Browser Extension Integration

See **EXTENSION_BACKEND_INTEGRATION.md** for complete steps.

**Quick summary:**
1. Add `config.js` to extension with API_BASE_URL
2. Add `backend-api.js` client library
3. Update `background.js` to call `backendAPI.saveEvent()` after analysis
4. Update `sidepanel.js` to sync profile and load events from backend

## ğŸ—„ï¸ Database Schema

### Tables

1. **user_profiles** - User configuration
   - Company info (name, role, product, value prop)
   - Target personas and industries
   - Deal metrics (size, conversion rate, win rate)
   - Event goals and notes

2. **events** - Event metadata
   - URL, name, dates (date, startDate, endDate)
   - Location, description
   - Estimated attendees
   - Analysis timestamps

3. **people** - People at events
   - Name, role, title, company
   - Persona category
   - LinkedIn profile
   - Personalized messages and ice breakers

4. **sponsors** - Event sponsors
   - Company name
   - Sponsor tier (Platinum, Gold, etc.)

5. **expected_personas** - Target personas
   - Persona type (VP Operations, CTO, etc.)
   - Likelihood of attendance
   - Estimated count
   - Conversation starters (JSON array)
   - Keywords (JSON array)
   - Pain points (JSON array)

6. **next_best_actions** - Recommended actions
   - Priority (1, 2, 3...)
   - Action description
   - Reason/context

7. **related_events** - Similar events
   - Event name and URL
   - Date
   - Relevance explanation

### Relationships

```
user_profiles
â””â”€> events (via user_id)
    â”œâ”€> people (via event_id)
    â”œâ”€> sponsors (via event_id)
    â”œâ”€> expected_personas (via event_id)
    â”œâ”€> next_best_actions (via event_id)
    â””â”€> related_events (via event_id)
```

## ğŸ”Œ API Endpoints

All endpoints are under `/api/` prefix:

### Events
- `POST /api/events` - Save event analysis
- `GET /api/events` - List events (supports limit, offset, date filters)
- `GET /api/events/:url` - Get specific event (URL-encoded)
- `DELETE /api/events/:url` - Delete event
- `POST /api/events/bulk` - Bulk import events

### Profile
- `POST /api/profile` - Save/update user profile
- `GET /api/profile` - Get user profile

### Search & Analytics
- `GET /api/people/search?q=...` - Search people across all events
- `GET /api/analytics/summary` - Get aggregate analytics

See **EVENT_API.md** for detailed documentation with request/response examples.

## ğŸ” Authentication

### Optional Bearer Token

Set `MCP_BEARER_TOKEN` environment variable to enable authentication:

```bash
export MCP_BEARER_TOKEN=$(openssl rand -hex 32)
```

Extension must include in all requests:
```javascript
headers: {
  'Authorization': 'Bearer YOUR_TOKEN_HERE'
}
```

### User Identification

Pass user ID via:
- Header: `X-User-Id: user123`
- Query param: `?userId=user123`

Each user's data is isolated by their userId.

## ğŸ“Š Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Extension  â”‚
â”‚                     â”‚
â”‚  1. User analyzes   â”‚
â”‚     event page      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gemini API        â”‚
â”‚   (via background)  â”‚
â”‚                     â”‚
â”‚  2. AI extracts     â”‚
â”‚     all event data  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Local Storage      â”‚  â”‚  Backend    â”‚  â”‚  Turso DB   â”‚
â”‚  (Chrome)           â”‚  â”‚  API        â”‚  â”‚             â”‚
â”‚                     â”‚  â”‚             â”‚  â”‚             â”‚
â”‚  3. Cache locally   â”‚  â”‚  4. POST    â”‚  â”‚  5. Store   â”‚
â”‚     for offline     â”‚  â”‚     /events â”‚  â”‚     forever â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits:**
- Immediate local access (cached in Chrome storage)
- Persistent cloud storage (survives cache clears)
- Cross-device sync (access from any device)
- Advanced search & analytics (query all events)

## ğŸ¨ Example Event Data

Here's what gets saved from a single event analysis:

```json
{
  "url": "https://www.saastr.com/saastr-annual-2026/",
  "eventName": "SaaStr Annual 2026",
  "date": "September 9-11, 2026",
  "startDate": "2026-09-09",
  "endDate": "2026-09-11",
  "location": "San Francisco, CA",
  "description": "The world's largest B2B software conference",
  "estimatedAttendees": 15000,
  
  "people": [
    {
      "name": "Jason Lemkin",
      "role": "Host",
      "title": "Founder & CEO",
      "company": "SaaStr",
      "persona": "Founder",
      "linkedin": "https://linkedin.com/in/jasonmlr",
      "linkedinMessage": "Hi Jason, excited for SaaStr 2026! Would love to connect.",
      "iceBreaker": "What's the theme for this year's conference?"
    },
    {
      "name": "Sarah Chen",
      "role": "Speaker",
      "title": "VP of Sales",
      "company": "Salesforce",
      "persona": "Executive",
      "linkedin": "https://linkedin.com/in/sarahchen",
      "linkedinMessage": "Hi Sarah, looking forward to your talk on enterprise sales.",
      "iceBreaker": "How are you thinking about AI in sales processes?"
    }
  ],
  
  "sponsors": [
    {
      "name": "HubSpot",
      "tier": "Platinum"
    },
    {
      "name": "Stripe",
      "tier": "Gold"
    }
  ],
  
  "expectedPersonas": [
    {
      "persona": "VP of Sales",
      "likelihood": "High",
      "count": "500+",
      "linkedinMessage": "Hi! I see you're attending SaaStr. Would love to connect.",
      "iceBreaker": "What brings you to SaaStr this year?",
      "conversationStarters": [
        "How are you thinking about AI in your sales process?",
        "What's your biggest challenge scaling your sales team?",
        "Have you tried any new sales engagement tools recently?"
      ],
      "keywords": ["sales", "revenue", "growth", "pipeline", "quota"],
      "painPoints": [
        "Inconsistent pipeline visibility",
        "Sales team productivity",
        "Lead qualification at scale"
      ]
    },
    {
      "persona": "CTO",
      "likelihood": "Medium",
      "count": "200+",
      "linkedinMessage": "Hi! Fellow SaaStr attendee here. Let's connect!",
      "iceBreaker": "What sessions are you most excited about?",
      "conversationStarters": [
        "How are you handling technical scaling challenges?",
        "What's your AI/ML strategy for 2026?",
        "How do you balance tech debt vs new features?"
      ],
      "keywords": ["architecture", "scalability", "infrastructure", "AI"],
      "painPoints": [
        "Technical debt accumulation",
        "Scaling engineering team",
        "Cloud cost optimization"
      ]
    }
  ],
  
  "nextBestActions": [
    {
      "priority": 1,
      "action": "Reach out to Sarah Chen (Salesforce) on LinkedIn before event",
      "reason": "Key decision maker at target account, speaking at event"
    },
    {
      "priority": 2,
      "action": "Register for early bird tickets (save 30%)",
      "reason": "Price increases after July 1st"
    },
    {
      "priority": 3,
      "action": "Research HubSpot and Stripe's sponsorship activations",
      "reason": "Both are competitors - understand their positioning"
    }
  ],
  
  "relatedEvents": [
    {
      "name": "SaaSOpen",
      "url": "https://www.saasopen.com",
      "date": "October 2026",
      "relevance": "Similar B2B SaaS audience, hosted by SaaStr"
    },
    {
      "name": "Dreamforce 2026",
      "url": "https://www.salesforce.com/dreamforce/",
      "date": "September 2026",
      "relevance": "Large enterprise software conference, similar personas"
    }
  ],
  
  "analyzedAt": "2026-01-15T10:30:00Z"
}
```

## ğŸ§ª Testing

### Manual Testing

```bash
# Test event creation
curl -X POST http://localhost:3000/api/events \
  -H "Content-Type: application/json" \
  -H "X-User-Id: test123" \
  -d @test-event.json

# List events
curl http://localhost:3000/api/events?userId=test123

# Get specific event
EVENT_URL="https://example.com/conference"
ENCODED=$(node -e "console.log(encodeURIComponent('$EVENT_URL'))")
curl "http://localhost:3000/api/events/$ENCODED?userId=test123"

# Search people
curl "http://localhost:3000/api/people/search?q=engineer&userId=test123"

# Get analytics
curl "http://localhost:3000/api/analytics/summary?userId=test123"
```

### Automated Testing

Create test script:

```javascript
// test-api.js
const BASE_URL = 'http://localhost:3000/api';
const USER_ID = 'test_user_' + Date.now();

async function testAPI() {
  // Test profile
  const profileRes = await fetch(`${BASE_URL}/profile`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-Id': USER_ID,
    },
    body: JSON.stringify({
      companyName: 'Test Corp',
      product: 'Test Product',
    }),
  });
  console.log('Profile saved:', profileRes.ok);

  // Test event
  const eventRes = await fetch(`${BASE_URL}/events`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-User-Id': USER_ID,
    },
    body: JSON.stringify({
      url: 'https://example.com/test-event',
      eventName: 'Test Event',
      people: [],
      sponsors: [],
      expectedPersonas: [],
      nextBestActions: [],
      relatedEvents: [],
    }),
  });
  console.log('Event saved:', eventRes.ok);

  // Test list events
  const listRes = await fetch(`${BASE_URL}/events?userId=${USER_ID}`);
  const data = await listRes.json();
  console.log('Events loaded:', data.count);
}

testAPI();
```

Run with: `node test-api.js`

## ğŸš€ Production Deployment

### Option 1: Railway

```bash
# Push to GitHub
git add .
git commit -m "Add backend API for event data"
git push

# In Railway dashboard:
# 1. New Project â†’ Deploy from GitHub
# 2. Select your repo
# 3. Add environment variables:
#    - TURSO_DATABASE_URL
#    - TURSO_AUTH_TOKEN
#    - MCP_BEARER_TOKEN (generate secure token)
# 4. Deploy
```

### Option 2: Fly.io

```bash
cd unified-mcp-server

fly launch
fly secrets set TURSO_DATABASE_URL="libsql://..."
fly secrets set TURSO_AUTH_TOKEN="..."
fly secrets set MCP_BEARER_TOKEN="$(openssl rand -hex 32)"
fly deploy
```

### Option 3: Vercel

```bash
# Install Vercel CLI
npm i -g vercel

cd unified-mcp-server

# Deploy
vercel

# Set secrets
vercel env add TURSO_DATABASE_URL
vercel env add TURSO_AUTH_TOKEN
vercel env add MCP_BEARER_TOKEN
```

### Update Extension for Production

In `chrome-extension/config.js`:
```javascript
const CONFIG = {
  API_BASE_URL: 'https://your-backend.railway.app/api',
  BEARER_TOKEN: 'your_production_bearer_token',
  USER_ID: null, // Auto-generated
};
```

## ğŸ“ˆ Monitoring

### Logs

**Railway:** View logs in dashboard
**Fly.io:** `fly logs`
**Vercel:** View logs in dashboard

### Metrics to Track

- Total events stored
- Total users (unique user IDs)
- API response times
- Error rates
- Database size

### Health Monitoring

Set up uptime monitoring with:
- Better Stack (formerly Better Uptime)
- Pingdom
- UptimeRobot

Monitor: `https://your-backend.com/health`

## ğŸ› Troubleshooting

### Backend won't start

**Error:** `TURSO_DATABASE_URL and TURSO_AUTH_TOKEN must be set`
**Fix:** Create `.env` file with credentials

**Error:** `Port 3000 already in use`
**Fix:** Kill existing process: `lsof -ti:3000 | xargs kill -9`
or change PORT in .env

### Extension can't connect

**Error:** `Failed to fetch` in console
**Fix:** 
1. Verify backend is running: `curl http://localhost:3000/health`
2. Check API_BASE_URL in config.js
3. Check browser console for CORS errors

**Error:** `401 Unauthorized`
**Fix:** 
1. Verify bearer token matches in extension and backend
2. Check Authorization header format: `Bearer YOUR_TOKEN`

### Events not saving

**Check backend logs** for specific errors

**Common issues:**
- Invalid JSON format
- Missing required fields (url, eventName)
- Database connection issues
- CORS blocking request

**Debug:**
```bash
# Test with curl to isolate client vs server
curl -X POST http://localhost:3000/api/events \
  -H "Content-Type: application/json" \
  -H "X-User-Id: debug" \
  -d '{"url":"https://test.com","eventName":"Test","people":[],"sponsors":[],"expectedPersonas":[],"nextBestActions":[],"relatedEvents":[]}'
```

### Database issues

**Error:** `Failed to connect to Turso`
**Fix:**
1. Verify TURSO_DATABASE_URL format: `libsql://your-db.turso.io`
2. Check TURSO_AUTH_TOKEN is valid
3. Test connection: `npm run init-db`

## ğŸ“š Documentation

- **EVENT_API.md** - Complete API reference with examples
- **EXTENSION_BACKEND_INTEGRATION.md** - Step-by-step integration guide
- **BACKEND_SETUP_SUMMARY.md** - Quick start and overview
- **README_BACKEND_INTEGRATION.md** - This file

## ğŸ¯ Next Steps

1. **Start backend**: `npm start` in unified-mcp-server/
2. **Test health check**: `curl http://localhost:3000/health`
3. **Integrate extension**: Follow EXTENSION_BACKEND_INTEGRATION.md
4. **Test end-to-end**: Analyze event, verify in database
5. **Deploy to production**: Choose Railway, Fly.io, or Vercel
6. **Enable authentication**: Set MCP_BEARER_TOKEN
7. **Monitor**: Set up uptime checks

## âœ¨ Features Enabled

- âœ… **Cross-device sync** - Access events from any device
- âœ… **Permanent storage** - Never lose data from cache clears
- âœ… **Advanced search** - Find people across all events
- âœ… **Analytics** - Aggregate stats, ROI calculations
- âœ… **API access** - Integrate with CRM, reporting tools
- âœ… **Team collaboration** - Ready for team sharing features

## ğŸ¤ Support

For questions or issues:
1. Check backend logs
2. Review API documentation (EVENT_API.md)
3. Test with curl to isolate issues
4. Check TypeScript types for data structure

---

**Backend is fully integrated and ready to capture all extension data! ğŸ‰**
